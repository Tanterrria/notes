# Описание оконных функций SQL


### ROWS или RANGE

* Инструкция **ROWS** позволяет ограничить строки в окне, указывая фиксированное количество строк, предшествующих или следующих за текущей.
* Инструкция **RANGE**, в отличие от ROWS, работает не со строками, а с диапазоном строк в инструкции ORDER BY. То есть под одной строкой для RANGE могут пониматься несколько физических строк одинаковых по рангу.

Обе инструкции ROWS и RANGE всегда используются вместе с ORDER BY.
В выражении для ограничения строк ROWS или RANGE также можно использовать следующие ключевые слова:

* **UNBOUNDED PRECEDING** — указывает, что окно начинается с первой строки группы;
* **UNBOUNDED FOLLOWING** – с помощью данной инструкции можно указать, что окно заканчивается на последней строке группы;
* **CURRENT ROW** – инструкция указывает, что окно начинается или заканчивается на текущей строке;
* **BETWEEN** «граница окна» AND «граница окна» — указывает нижнюю и верхнюю границу окна;
* «Значение» **PRECEDING** – определяет число строк перед текущей строкой (не допускается в предложении RANGE).;
* «Значение» **FOLLOWING** — определяет число строк после текущей строки (не допускается в предложении RANGE).

Разберем на примере:

```sql
    sum(value) over (partition by territory, periodicity, extract(year from period) order by territory, periodicity, period rows between unbounded preceding and current row), 0)/1000 as value
    
    SELECT 
      Date
    , Medium
    , Conversions
    , SUM(Conversions) OVER(PARTITION BY Date ORDER BY Conversions ROWS BETWEEN CURRENT ROW AND 1 FOLLOWING) AS 'Sum' 
    FROM Orders
```

### Виды функций

Оконные функции можно подразделить на следующие группы:
 
* Агрегатные функции;
* Ранжирующие функции;
* Функции смещения;
* Аналитические функции.

### Агрегатные функции

_Агрегатные функции_ – это функции, которые выполняют на наборе данных арифметические вычисления и возвращают итоговое значение.

* **SUM** – возвращает сумму значений в столбце;
* **COUNT** — вычисляет количество значений в столбце (значения NULL не учитываются);
* **AVG** — определяет среднее значение в столбце;
* **MAX** — определяет максимальное значение в столбце;
* **MIN** — определяет минимальное значение в столбце.
	
### Ранжирующие функции

_Ранжирующие функции_ – это функции, которые ранжируют значение для каждой строки в окне. Например, их можно использовать для того, чтобы присвоить порядковый номер строке или составить рейтинг.

* **ROW_NUMBER** – функция возвращает номер строки и используется для нумерации;
* **RANK** — функция возвращает ранг каждой строки. В данном случае значения уже анализируются и, в случае нахождения одинаковых, возвращает одинаковый ранг с пропуском следующего значения;
* **DENSE_RANK** — функция возвращает ранг каждой строки. Но в отличие от функции RANK, она для одинаковых значений возвращает ранг, не пропуская следующий;
* **NTILE** – это функция, которая позволяет определить к какой группе относится текущая строка. Количество групп задается в скобках.

```sql
  SELECT 
    Date
  , Medium
  , Conversions
  , ROW_NUMBER() OVER(PARTITION BY Date ORDER BY Conversions) AS 'Row_number' 
  , RANK() OVER(PARTITION BY Date ORDER BY Conversions) AS 'Rank' 
  , DENSE_RANK() OVER(PARTITION BY Date ORDER BY Conversions) AS 'Dense_Rank' 
  , NTILE(3) OVER(PARTITION BY Date ORDER BY Conversions) AS 'Ntile'
  FROM Orders
```

### Функции смещения

_Функции смещения_ – это функции, которые позволяют перемещаться и обращаться к разным строкам в окне, относительно текущей строки, а также обращаться к значениям в начале или в конце окна.

* **LAG** или **LEAD** – функция LAG обращается к данным из предыдущей строки окна, а LEAD к данным из следующей строки. Функцию можно использовать для того, чтобы сравнивать текущее значение строки с предыдущим или следующим. Имеет три параметра: столбец, значение которого необходимо вернуть, количество строк для смещения (по умолчанию 1), значение, которое необходимо вернуть если после смещения возвращается значение NULL;
**FIRST_VALUE** или **LAST_VALUE** — с помощью функции можно получить первое и последнее значение в окне. В качестве параметра принимает столбец, значение которого необходимо вернуть.

```sql
  SELECT 
    Date
  , Medium
  , Conversions
  , LAG(Conversions) OVER(PARTITION BY Date ORDER BY Date) AS 'Lag' 
  , LEAD(Conversions) OVER(PARTITION BY Date ORDER BY Date) AS 'Lead' 
  , FIRST_VALUE(Conversions) OVER(PARTITION BY Date ORDER BY Date) AS 'First_Value' 
  , LAST_VALUE(Conversions) OVER(PARTITION BY Date ORDER BY Date) AS 'Last_Value'
  FROM Orders
```

### Аналитические функции

_Аналитические функции_ — это функции которые возвращают информацию о распределении данных и используются для статистического анализа.

* **CUME_DIST** — вычисляет интегральное распределение (относительное положение) значений в окне;
* **PERCENT_RANK** — вычисляет относительный ранг строки в окне;
* **PERCENTILE_CONT** — вычисляет процентиль на основе постоянного распределения значения столбца. В качестве параметра принимает процентиль, который необходимо вычислить (в этой статье я рассказываю как посчитать медиану, благодаря этой функции);
* **PERCENTILE_DISC** — вычисляет определенный процентиль для отсортированных значений в наборе данных. В качестве параметра принимает процентиль, который необходимо вычислить.
Важно! У функций PERCENTILE_CONT и PERCENTILE_DISC, столбец, по которому будет происходить сортировка, указывается с помощью ключевого слова WITHIN GROUP.

 ```sql
    SELECT 
      Date
    , Medium
    , Conversions
    , CUME_DIST() OVER(PARTITION BY Date ORDER BY Conversions) AS 'Cume_Dist' 
    , PERCENT_RANK() OVER(PARTITION BY Date ORDER BY Conversions) AS 'Percent_Rank' 
    , PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY Conversions) OVER(PARTITION BY Date) AS 'Percentile_Cont' 
    , PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY Conversions) OVER(PARTITION BY Date) AS 'Percentile_Disc'
    FROM Orders
```
